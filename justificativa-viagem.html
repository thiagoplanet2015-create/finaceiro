<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Justificativa de Despesas de Viagem (Empresa)</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Bootstrap Icons (opcional para ícones nos labels) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <!-- Estilo aprimorado -->
  <style>
    :root{
      --brand:#2563eb;          /* azul primário */
      --brand-600:#1d4ed8;
      --ink:#0f172a;             /* texto */
      --muted:#64748b;           /* texto secundário */
      --paper:#ffffff;           /* fundo card */
      --bg:#f3f6fb;              /* fundo página */
      --success:#16a34a;
      --danger:#e11d48;
      --border:#e5e7eb;
      --table-stripe:#fafbff;
    }

    /* Página */
    body{ background:var(--bg); color:var(--ink); }
    h1,h2,h3,h4,h5 { color:var(--ink); letter-spacing:.2px; }
    .page-title{
      font-weight:700;
      font-size: clamp(1.1rem, 1.2rem + .5vw, 1.6rem);
      display:flex; align-items:center; gap:.6rem;
    }
    .page-title .badge{
      background:linear-gradient(135deg,var(--brand),#0ea5e9);
      border:none; font-weight:600;
    }

    /* Cards */
    .card{
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(2,6,23,.05);
    }
    .card-header{
      background:linear-gradient(180deg,#fff, #fafafa);
      border-bottom:1px solid var(--border);
      border-top-left-radius:12px; border-top-right-radius:12px;
    }

    /* Formulário */
    .form-label{ font-weight:600; color:#334155; }
    .form-control,.form-select{
      border-radius:10px; border:1px solid var(--border);
      transition: border-color .2s, box-shadow .2s;
    }
    .form-control:focus,.form-select:focus{
      border-color: var(--brand);
      box-shadow: 0 0 0 .2rem rgba(37,99,235,.15);
    }
    .btn-primary{
      background:var(--brand); border-color:var(--brand);
      border-radius:10px; font-weight:600;
    }
    .btn-primary:hover{ background:var(--brand-600); border-color:var(--brand-600); }
    .btn-outline-primary{
      border-radius:10px; font-weight:600; color:var(--brand); border-color:var(--brand);
    }
    .btn-outline-primary:hover{ background:var(--brand); color:#fff; }

    /* Resumo */
    .preview-paper{
      background:var(--paper); border:1px solid var(--border);
      border-radius:12px; padding:18px;
    }
    .preview-header{
      display:flex; justify-content:space-between; align-items:center; gap:1rem;
    }
    .meta small{ color:var(--muted); }
    .meta .value{ font-weight:600; color:var(--ink); }

    /* Tabelas */
    .table{
      --bs-table-striped-bg: var(--table-stripe);
      border-color: var(--border);
    }
    .table thead th{
      position:sticky; top:0; background:#fff; z-index:2;
      border-bottom:2px solid var(--border); color:#475569; font-weight:700;
    }
    .table>tbody>tr>td, .table>thead>tr>th{
      vertical-align: middle;
    }
    .table-sm td, .table-sm th{ padding:.55rem .6rem; }

    /* Quadro de totais no resumo */
    .totals-card{
      border:1px dashed var(--border); border-radius:10px; padding:.5rem .75rem;
      background:#fcfdff;
    }
    .totals-card .label{ color:var(--muted); }
    .totals-card .value{ font-weight:700; }
    .totals-card .value.success{ color:var(--success); }
    .totals-card .value.danger{ color:var(--danger); }

    /* Linhas de assinatura */
    .sign-line{
      border-top:1px solid var(--border); height:1px; margin:24px 0 6px;
    }

    /* Chips de contexto (empresa/usuário) */
    .chip{
      padding:.25rem .6rem; border-radius:999px; font-size:.78rem; font-weight:600;
      background:#eef2ff; color:var(--brand); border:1px solid #e0e7ff;
    }

    @media (max-width: 992px){
      .preview-header{ flex-direction:column; align-items:flex-start; }
    }
  </style>
</head>
<body>
<div class="container my-4">

  <!-- Cabeçalho com contexto -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="page-title">
      Justificativa de Despesas de Viagem – Empresa
      <span class="badge text-bg-primary">Protótipo</span>
    </div>
    <div class="d-flex gap-2 text-muted small">
      <span class="chip">Empresa: <strong id="empresaSpan">-</strong></span>
      <span class="chip">Usuário: <strong id="usuarioSpan">-</strong></span>
    </div>
  </div>

  <div class="row g-3">
    <!-- Formulário -->
    <div class="col-12 col-lg-6">
      <div class="card">
        <div class="card-body">
          <form id="formJust" novalidate>
            <h6 class="mb-3">Identificação</h6>
            <div class="row g-2">
              <div class="col-12">
                <label class="form-label"><i class="bi bi-building me-1 text-primary"></i>Empresa</label>
                <select id="empresa" class="form-select" required>
                  <option value="" selected>Selecione</option>
                  <option>Empresa A</option>
                  <option>Empresa B</option>
                  <option>Empresa C</option>
                </select>
                <div class="invalid-feedback">Selecione a empresa.</div>
              </div>
              <div class="col-12">
                <label class="form-label"><i class="bi bi-person me-1 text-primary"></i>Colaborador</label>
                <input id="colaborador" class="form-control" placeholder="Nome completo" required />
                <div class="invalid-feedback">Informe o nome.</div>
              </div>
              <div class="col-6">
                <label class="form-label"><i class="bi bi-card-list me-1 text-primary"></i>Matrícula</label>
                <input id="matricula" class="form-control" />
              </div>
              <div class="col-6">
                <label class="form-label"><i class="bi bi-diagram-3 me-1 text-primary"></i>Setor</label>
                <input id="setor" class="form-control" />
              </div>
            </div>

            <h6 class="mt-4 mb-2">Viagem</h6>
            <div class="row g-2">
              <div class="col-8">
                <label class="form-label"><i class="bi bi-geo-alt me-1 text-primary"></i>Local e Finalidade</label>
                <input id="finalidade" class="form-control" placeholder="Ex.: São Paulo – reunião com cliente" required />
                <div class="invalid-feedback">Informe o objetivo da viagem.</div>
              </div>
              <div class="col-4">
                <label class="form-label"><i class="bi bi-calendar3 me-1 text-primary"></i>Data</label>
                <input type="date" id="dataViagem" class="form-control" required />
                <div class="invalid-feedback">Informe a data.</div>
              </div>
            </div>

            <div class="mt-3">
              <label class="form-label"><i class="bi bi-chat-left-text me-1 text-primary"></i>Observações</label>
              <textarea id="obs" class="form-control" rows="2"></textarea>
            </div>

            <h6 class="mt-4 mb-2">Lançar Despesas</h6>
            <div class="row g-2 align-items-end">
              <div class="col-5">
                <label class="form-label">Descrição</label>
                <select id="desc" class="form-select">
                   <option> ALUGUÉIS DE IMÓVEIS</option>
                   <option> ALUGUÉIS DE VEÍCULO</option>
                   <option> ANÚNCIOS E PUBLICAÇ</option>
                   <option> AUXÍLIO FUNERAL	
                   <option> ASSINATURA DE TV CA</option>
                   <option> COMBUSTÍVEIS	
                   <option> CONSELHOS REGIONAIS</option>
                   <option> CONSULTORIA/ASSESSO</option>
                   <option> CONSULTORIA/ASSESSO</option>
                   <option> CONTA CAIXA	
                   <option> DESPESAS COM CARTÓR</option>
                   <option> DESPESAS COM HOSPED</option>
                   <option> DESPESAS COM PASSAG</option>
                   <option> DESPESAS COM TÁXI	</option>
                   <option> DESPESAS POSTAIS E </option>
                   <option> EV. - DATAS COMEMOR</option>
                   <option> EV. - CONFRATERNIZA</option>
                   <option> EXAMES - PERIÓDICOS</option>
                   <option> JORNAIS/REVISTAS/LI</option>
                   <option> LANCHES E CAFÉS ESP</option>
                   <option> LICENCIAMENTO DE VE</option>
                   <option> MATERIAIS DE ESCRIT</option>
                   <option> PEÇAS E MATERIAIS D</option>
                   <option> PEDÁGIOS E ESTACION</option>
                   <option> REFEIÇÕES E LANCHES</option>
                   <option> ROUPARIA E LAVANDER</option>
                   <option> SEGURO DE VEÍCULO	</option>
                   <option> SERVIÇOS DE TERCEIR</option>
                   <option> SERVIÇOS DE TERCEIR</option>
                   <option> TRAVESSIA/BALSA	
                   <option> TELEFONEMAS - MÓVEL</option>
                   <option> TAXAS DIVERSAS</option>
                </select>
              </div>
              <div class="col-3">
                <label class="form-label">Data</label>
                <input type="date" id="dataDesp" class="form-control" />
              </div>
              <div class="col-2">
                <label class="form-label">Qtd</label>
                <input type="number" step="1" id="qtd" class="form-control" value="1" />
              </div>
              <div class="col-2">
                <label class="form-label">Valor</label>
                <input type="number" step="0.01" id="valor" class="form-control text-end" placeholder="0,00" />
              </div>
              <div class="col-12 mt-2">
                <label class="form-label">Comprovante (opcional)</label>
                <input type="file" id="anexo" class="form-control" accept="image/*,application/pdf" />
                <div class="form-text">Você pode anexar imagens ou PDF do recibo/nota.</div>
              </div>
              <div class="col-12 d-grid mt-2">
                <button class="btn btn-outline-primary" type="button" id="addLinha">Adicionar</button>
              </div>
            </div>

            <div class="table-responsive mt-3" style="max-height: 280px;">
              <table class="table table-sm align-middle" id="tabela">
                <thead>
                <tr>
                  <th style="min-width:160px;">Descrição</th>
                  <th>Data</th>
                  <th class="text-end">Qtd</th>
                  <th class="text-end">Valor unit.</th>
                  <th class="text-end">Subtotal</th>
                  <th>Anexo</th>
                  <th></th>
                </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                <tr>
                  <th colspan="4" class="text-end">Total de despesas:</th>
                  <th class="text-end" id="totalDesp">R$ 0,00</th>
                  <th colspan="2"></th>
                </tr>
                </tfoot>
              </table>
            </div>

            <h6 class="mt-4 mb-2">Adiantamento recebido</h6>
            <div class="row g-2">
              <div class="col-6">
                <label class="form-label">Valor do adiantamento (R$)</label>
                <input type="number" step="0.01" id="adiantamento" class="form-control text-end" value="0" />
              </div>
              <div class="col-6">
                <label class="form-label">Situação</label>
                <input id="situacao" class="form-control" readonly value="—" />
              </div>
            </div>

            <div class="d-grid mt-4">
              <button class="btn btn-primary" type="submit">Gerar Resumo</button>
            </div>
          </form>
        </div>
      </div>
      <p class="text-muted mt-2">
        Dica: use “Imprimir/Salvar PDF” no resumo para enviar ao financeiro.
      </p>
    </div>

    <!-- Resumo/Prévia -->
    <div class="col-12 col-lg-6">
      <div class="card">
        <div class="card-body">
          <div class="preview-paper" id="resumo">
            <div class="preview-header">
              <h5 class="mb-0">Resumo da Justificativa</h5>
              <button class="btn btn-outline-secondary btn-sm" onclick="window.print()">
                <i class="bi bi-printer me-1"></i>Imprimir / Salvar PDF
              </button>
            </div>

            <div class="row g-2 mt-3">
              <div class="col-lg-7 meta">
                <div><small>Empresa:</small> <span class="value" id="r_empresa">—</span></div>
                <div><small>Colaborador:</small> <span class="value" id="r_colaborador">—</span></div>
                <div><small>Matrícula:</small> <span class="value" id="r_matricula">—</span>
                     <small class="ms-2">Setor:</small> <span class="value" id="r_setor">—</span></div>
              </div>
              <div class="col-lg-5 meta">
                <div><small>Local/Finalidade:</small> <span class="value" id="r_finalidade">—</span></div>
                <div><small>Data:</small> <span class="value" id="r_dataViagem">__/__/____</span></div>
              </div>
            </div>

            <hr/>

            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                <tr>
                  <th>Descrição</th>
                  <th>Data</th>
                  <th class="text-end">Qtd</th>
                  <th class="text-end">Valor unit.</th>
                  <th class="text-end">Subtotal</th>
                </tr>
                </thead>
                <tbody id="r_itens"></tbody>
              </table>
            </div>

            <div class="row">
              <div class="col-lg-8">
                <div class="small text-muted"><strong>Observações:</strong> <span id="r_obs">—</span></div>
              </div>
              <div class="col-lg-4">
                <div class="totals-card">
                  <div class="d-flex justify-content-between">
                    <span class="label">Total de gastos</span>
                    <span class="value" id="r_total">R$ 0,00</span>
                  </div>
                  <div class="d-flex justify-content-between">
                    <span class="label">Adiantamento</span>
                    <span class="value" id="r_adiant">R$ 0,00</span>
                  </div>
                  <div class="d-flex justify-content-between">
                    <span class="label">A devolver empresa</span>
                    <span class="value danger" id="r_devolver">R$ 0,00</span>
                  </div>
                  <div class="d-flex justify-content-between">
                    <span class="label">A receber funcionário</span>
                    <span class="value success" id="r_receber">R$ 0,00</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="row mt-4 text-center">
              <div class="col-6">
                <div class="sign-line"></div>
                <div>Gerência</div>
              </div>
              <div class="col-6">
                <div class="sign-line"></div>
                <div>Funcionário</div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Script: mantém o comportamento e sincroniza apenas o Resumo -->
<script>
  // Contexto vindo do login para exibir no topo e no resumo
  const empCtx = sessionStorage.getItem('empresa') || '';
  const usrCtx = sessionStorage.getItem('usuario') || '';
  if (empCtx) document.getElementById('empresaSpan').textContent = empCtx;
  if (usrCtx) document.getElementById('usuarioSpan').textContent = usrCtx;

  // Helpers
  const brMoney = v => (Number(v||0)).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  const fmtDate = v => v ? new Date(v).toLocaleDateString('pt-BR') : '__/__/____';

  // Estado dos itens (linhas de despesa)
  const itens = [];

  // Apenas atualizar o RESUMO conforme o usuário digita (form permanece intocado)
  ['empresa','colaborador','matricula','setor','finalidade','dataViagem','obs'].forEach(id=>{
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('input', syncResumoHeader);
    el.addEventListener('change', syncResumoHeader);
  });

  // Preenche o resumo com login como padrão inicial, sem mexer no formulário
  function initResumoWithLogin() {
    document.getElementById('r_empresa').textContent = empCtx || '—';
    if (usrCtx) document.getElementById('r_colaborador').textContent = usrCtx;
  }
  initResumoWithLogin();

  function syncResumoHeader(){
    const empresa = document.getElementById('empresa')?.value || document.getElementById('r_empresa').textContent || '—';
    const colaborador = document.getElementById('colaborador')?.value || document.getElementById('r_colaborador').textContent || '—';
    const matricula = document.getElementById('matricula')?.value || '—';
    const setor = document.getElementById('setor')?.value || '—';
    const finalidade = document.getElementById('finalidade')?.value || '—';
    const dataV = document.getElementById('dataViagem')?.value || '';

    document.getElementById('r_empresa').textContent = empresa || '—';
    document.getElementById('r_colaborador').textContent = colaborador || '—';
    document.getElementById('r_matricula').textContent = matricula || '—';
    document.getElementById('r_setor').textContent = setor || '—';
    document.getElementById('r_finalidade').textContent = finalidade || '—';
    document.getElementById('r_dataViagem').textContent = fmtDate(dataV);
    document.getElementById('r_obs').textContent = document.getElementById('obs')?.value || '—';
  }
  // Inicial
  syncResumoHeader();

  // Lançamento de despesas
  document.getElementById('addLinha').addEventListener('click', () => {
    const desc = document.getElementById('desc').value;
    const data = document.getElementById('dataDesp').value;
    const qtd  = Number(document.getElementById('qtd').value || 1);
    const val  = Number(document.getElementById('valor').value || 0);
    const anexoInput = document.getElementById('anexo');
    const anexoNome = anexoInput.files[0]?.name || '';

    if (!desc || val <= 0 || qtd <= 0) {
      alert('Informe descrição, quantidade e valor (>0).');
      return;
    }

    const subtotal = qtd * val;
    itens.push({ id: crypto.randomUUID(), desc, data, qtd, val, subtotal, anexoNome });
    renderTabela();
    document.getElementById('valor').value = '';
    document.getElementById('qtd').value = 1;
    document.getElementById('anexo').value = '';
  });

  function renderTabela(){
    const tbody = document.querySelector('#tabela tbody');
    tbody.innerHTML = '';
    let total = 0;
    itens.forEach(it => {
      total += it.subtotal;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${it.desc}</td>
        <td>${fmtDate(it.data)}</td>
        <td class="text-end">${it.qtd}</td>
        <td class="text-end">${brMoney(it.val)}</td>
        <td class="text-end">${brMoney(it.subtotal)}</td>
        <td>${it.anexoNome || '-'}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-danger" onclick="removerItem('${it.id}')">Remover</button>
        </td>`;
      tbody.appendChild(tr);
    });
    document.getElementById('totalDesp').textContent = brMoney(total);
    recalcularResumo();

    // atualiza a tabela do Resumo
    const rtbody = document.getElementById('r_itens');
    rtbody.innerHTML = '';
    itens.forEach(it => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${it.desc}</td>
        <td>${fmtDate(it.data)}</td>
        <td class="text-end">${it.qtd}</td>
        <td class="text-end">${brMoney(it.val)}</td>
        <td class="text-end">${brMoney(it.subtotal)}</td>`;
      rtbody.appendChild(tr);
    });
  }

  window.removerItem = (id) => {
    const idx = itens.findIndex(x=>x.id===id);
    if (idx>=0){ itens.splice(idx,1); renderTabela(); }
  }

  function somaTotal(){ return itens.reduce((a,c)=>a+c.subtotal,0); }

  function recalcularResumo(){
    const total = somaTotal();
    const ad = Number(document.getElementById('adiantamento').value || 0);
    const dif = total - ad;

    document.getElementById('situacao').value =
      dif>0 ? `Empresa deve pagar R$ ${brMoney(dif).replace('R$ ','')}` :
      dif<0 ? `Colaborador deve devolver R$ ${brMoney(-dif).replace('R$ ','')}` : 'Quitado';

    document.getElementById('r_total').textContent = brMoney(total);
    document.getElementById('r_adiant').textContent = brMoney(ad);
    document.getElementById('r_devolver').textContent = brMoney(dif<0 ? -dif : 0);
    document.getElementById('r_receber').textContent = brMoney(dif>0 ? dif : 0);
  }

  document.getElementById('adiantamento').addEventListener('input', recalcularResumo);

  // Submit: sincroniza e rola
  document.getElementById('formJust').addEventListener('submit', (e)=>{
    e.preventDefault();
    const req = ['empresa','colaborador','finalidade','dataViagem'];
    let ok = true;
    req.forEach(id=>{
      const el = document.getElementById(id);
      if(!el.value.trim()){ el.classList.add('is-invalid'); ok=false; } else el.classList.remove('is-invalid');
    });
    if(!ok) return;
    syncResumoHeader();
    recalcularResumo();
    document.getElementById('resumo').scrollIntoView({behavior:'smooth'});
  });
</script>
</body>
</html>