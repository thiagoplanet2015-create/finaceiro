<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Portal Financeiro - Relatório de Adiantamento</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --brand: #72bf44;
        --brand-600: #5fa535;
        --brand-light: #9fc612;
        --ink: #0f172a;
        --muted: #64748b;
        --paper: #ffff;
        --bg: #f3f6fb;
        --success: #72bf44;
        --danger: #e11d48;
        --border: #e5e7eb;
        --table-stripe: #fafbff;
      }
      body {
        background: var(--bg);
        color: var(--ink);
      }
      h1,
      h2,
      h3,
      h4,
      h5 {
        color: var(--ink);
        letter-spacing: 0.2px;
      }
      .topbar {
        background: linear-gradient(
          135deg,
          var(--brand) 0%,
          var(--brand-600) 100%
        );
        color: #fff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .topbar .fw-bold {
        color: #fff;
        font-size: 1.2rem;
      }
      .topbar .text-muted {
        color: rgba(255, 255, 255, 0.85) !important;
      }
      .card {
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(2, 6, 23, 0.05);
      }
      .card-header {
        background: linear-gradient(180deg, #f8fdf5, #e8f5e0);
        border-bottom: 1px solid var(--border);
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
      }
      .card-header h5 {
        color: var(--brand-600);
        font-weight: 700;
      }
      .report-item {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f1f5f9;
      }
      .report-item:last-child {
        border-bottom: none;
      }
      .report-item span,
      .report-grid-item span {
        color: #64748b;
        font-size: 0.9rem;
      }
      .report-item strong,
      .report-grid-item strong {
        color: #1e293b;
      }
      .json-container {
        background-color: #1e293b;
        color: #e2e8f0;
        border-radius: 0.375rem;
        padding: 1rem;
        max-height: 400px;
        overflow-y: auto;
      }
      .json-container code {
        white-space: pre-wrap;
      }
      .section-title {
        color: var(--brand-600);
        font-weight: 700;
        font-size: 1.2rem;
        margin-bottom: 1rem;
      }
      .btn-outline-secondary {
        border-radius: 10px;
        font-weight: 600;
      }
      .btn-outline-danger {
        border-radius: 8px;
        font-weight: 600;
      }
      .btn-primary {
        background: var(--brand);
        border-color: var(--brand);
        border-radius: 10px;
        font-weight: 600;
      }
      .btn-primary:hover {
        background: var(--brand-600);
        border-color: var(--brand-600);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(114, 191, 68, 0.3);
      }
    </style>
  </head>
  <body>
    <!-- Topbar -->
    <nav class="topbar">
      <div
        class="container py-2 d-flex align-items-center justify-content-between"
      >
        <div class="fw-bold">Portal Financeiro - Relatório de Adiantamento</div>
        <div class="text-muted small" id="header_info"></div>
      </div>
    </nav>

    <div class="container my-4">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <h4 class="mb-0">Relatório de Adiantamento ao Fornecedor</h4>
        <div>
          <button
            class="btn btn-outline-secondary btn-sm"
            onclick="window.history.back()"
          >
            ← Voltar
          </button>
          <button
            class="btn btn-outline-secondary btn-sm ms-2"
            onclick="window.print()"
          >
            Imprimir
          </button>
        </div>
      </div>

      <div class="col-lg-11 col-xl-10 p-0">
        <!-- Resumo da Solicitação -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0 section-title">Resumo da Solicitação</h5>
          </div>
          <div class="card-body">
            <div class="report-item">
              <span>Empresa</span><strong id="r_empresa">—</strong>
            </div>
            <div class="report-item">
              <span>Data da Solicitação</span><strong id="r_data">—</strong>
            </div>
            <div class="report-item">
              <span>Solicitante - Motivo</span
              ><strong id="r_setor_pagamento">—</strong>
            </div>
            <div class="report-item">
              <span>Fornecedor</span><strong id="r_fornecedor_nome">—</strong>
            </div>
            <div class="report-item">
              <span>CNPJ</span><strong id="r_fornecedor_cnpj">—</strong>
            </div>
            <div class="report-item">
              <span>Descrição</span
              ><strong id="r_descricao" class="text-end">—</strong>
            </div>
            <div class="report-item">
              <span>Anexos da Solicitação</span>
              <div id="r_anexos_solicitacao" class="text-end">
                Nenhum anexo.
              </div>
            </div>
          </div>
        </div>

        <!-- Valores -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0 section-title">Valores</h5>
          </div>
          <div class="card-body">
            <div class="report-item">
              <span>Valor Bruto</span
              ><strong id="r_valor_bruto">R$ 0,00</strong>
            </div>
            <div class="report-item">
              <span>Retenção</span><strong id="r_retencao">—</strong>
            </div>
            <div class="report-item">
              <span>Valor Líquido</span
              ><strong id="r_valor_liquido" class="text-success fw-bold"
                >R$ 0,00</strong
              >
            </div>
            <div class="report-item">
              <span>Data do Acerto</span><strong id="r_data_acerto">—</strong>
            </div>
          </div>
        </div>

        <!-- Pagamento e Anexos -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0 section-title">Pagamento e Anexos</h5>
          </div>
          <div class="card-body">
            <div class="report-item">
              <span>Metodo de Pagamento</span
              ><strong id="r_tipo_pagamento">—</strong>
            </div>
            <div class="report-item">
              <span>Data do Pagamento</span
              ><strong id="r_data_pagamento">—</strong>
            </div>
            <div id="r_dados_bancarios" style="display: none">
              <div class="report-item">
                <span>Banco</span><strong id="r_banco">—</strong>
              </div>
              <div class="report-item">
                <span>Agência</span><strong id="r_agencia">—</strong>
              </div>
              <div class="report-item">
                <span>Tipo de Conta</span><strong id="r_tipo_conta">—</strong>
              </div>
              <div class="report-item">
                <span>Número da Conta</span
                ><strong id="r_numero_conta">—</strong>
              </div>
            </div>
            <div
              class="report-item"
              id="r_boleto_anexos_row"
              style="display: none"
            >
              <span>Anexos do Boleto</span>
              <div id="r_anexos_boleto" class="text-end">Nenhum anexo.</div>
            </div>
          </div>
        </div>

        <!-- Informações para o Oracle -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0 section-title">Informações para o Oracle</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-3 mb-3 report-grid-item">
                <span>Moeda</span><br /><strong id="o_moeda">BRL</strong>
              </div>
              <div class="col-md-3 mb-3 report-grid-item">
                <span>Data GL</span><br /><strong id="o_data_gl">—</strong>
              </div>
              <div class="col-md-3 mb-3 report-grid-item">
                <span>Moeda de Pagamento</span><br /><strong
                  id="o_moeda_pagamento"
                  >BRL</strong
                >
              </div>
              <div class="col-md-3 mb-3 report-grid-item">
                <span>Data Taxa Pagto</span><br /><strong id="o_data_taxa_pagto"
                  >—</strong
                >
              </div>
              <div class="col-md-3 mb-3 report-grid-item">
                <span>Data das Condições</span><br /><strong
                  id="o_data_condicoes"
                  >—</strong
                >
              </div>
              <div class="col-md-3 mb-3 report-grid-item">
                <span>Condições</span><br /><strong id="o_condicoes"
                  >À vista</strong
                >
              </div>
              <div class="col-md-3 mb-3 report-grid-item">
                <span>Método de Pagamento</span><br /><strong
                  id="o_metodo_pagamento"
                  >Eletrônico</strong
                >
              </div>
              <div class="col-md-3 mb-3 report-grid-item">
                <span>Grupo de Pagamentos</span><br /><strong
                  id="o_grupo_pagamentos"
                  >Fornecedores</strong
                >
              </div>
              <div class="col-md-3 mb-3 report-grid-item">
                <span>País para Tributação</span><br /><strong
                  id="o_pais_tributacao"
                  >Brasil</strong
                >
              </div>
              <div class="col-md-3 mb-3 report-grid-item">
                <span>Vincular Ação</span><br /><strong id="o_vincular_acao"
                  >Ordem de Compra</strong
                >
              </div>
            </div>
          </div>
        </div>

        <!-- Payload JSON -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0 section-title">Payload JSON Gerado</h5>
          </div>
          <div class="card-body">
            <div class="d-flex justify-content-end mb-2">
              <button id="btnCopyJson" class="btn btn-sm btn-outline-secondary">
                Copiar JSON
              </button>
              <button
                id="btnDownloadJson"
                class="btn btn-sm btn-outline-secondary ms-2"
              >
                Download JSON
              </button>
            </div>
            <div class="json-container">
              <code id="json-payload-view">Aguardando dados...</code>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      const fmtBRL = (v) =>
        (v || 0).toLocaleString("pt-BR", {
          style: "currency",
          currency: "BRL",
        });
      const fmtDate = (d) =>
        d ? new Date(d + "T00:00:00").toLocaleDateString("pt-BR") : "—";

      function populateReport(data) {
        // Header
        $("header_info").textContent = `Empresa: ${
          data.empresa || "N/A"
        } • Usuário: agt@agt.com.br`;

        // Resumo
        $("r_empresa").textContent = data.empresa || "—";
        $("r_data").textContent = fmtDate(data.data);

        // Agora mostramos "Solicitante - Motivo" no lugar do Setor Pagamento
        const solicitante = data.solicitante || data.setor_pagamento || "";
        const descricao = data.descricao || "";
        if (solicitante || descricao) {
          const left = solicitante || "—";
          const right = descricao ? descricao.replace(/\n/g, " ") : "—";
          $("r_setor_pagamento").textContent = `${left} - ${right}`;
        } else {
          $("r_setor_pagamento").textContent = "—";
        }

        $("r_fornecedor_nome").textContent = data.fornecedor_nome || "—";
        $("r_fornecedor_cnpj").textContent = data.fornecedor_cnpj || "—";
        $("r_descricao").textContent = descricao || "—";

        // Anexos da Solicitação
        if (data.anexos_solicitacao && data.anexos_solicitacao.length > 0) {
          $("r_anexos_solicitacao").innerHTML = data.anexos_solicitacao
            .map((a) => `<div>${a.nome}</div>`)
            .join("");
        } else {
          $("r_anexos_solicitacao").textContent = "Nenhum anexo.";
        }

        // Valores
        $("r_valor_bruto").textContent = fmtBRL(data.valor_bruto);
        $("r_retencao").textContent =
          data.retencao && data.retencao.havera
            ? `Sim (${fmtBRL(data.retencao.valor)})`
            : "Não";
        $("r_valor_liquido").textContent = fmtBRL(data.valor_liquido);
        $("r_data_acerto").textContent = fmtDate(data.data_acerto);

        // Pagamento
        $("r_tipo_pagamento").textContent =
          data.pagamento && data.pagamento.tipo
            ? data.pagamento.tipo
            : data.pagamento
            ? data.pagamento.tipo
            : "—";
        $("r_data_pagamento").textContent = fmtDate(
          data.pagamento ? data.pagamento.data_pagamento : null
        );
        if (
          data.pagamento &&
          data.pagamento.tipo === "Eletronico" &&
          data.pagamento.bancarios
        ) {
          $("r_dados_bancarios").style.display = "block";
          $("r_banco").textContent = data.pagamento.bancarios.banco || "—";
          $("r_agencia").textContent = data.pagamento.bancarios.agencia || "—";
          $("r_tipo_conta").textContent =
            data.pagamento.bancarios.tipo_conta || "—";
          $("r_numero_conta").textContent =
            data.pagamento.bancarios.numero_conta || "—";
        }

        // Anexos do Boleto
        if (data.pagamento && data.pagamento.tipo === "boleto") {
          $("r_boleto_anexos_row").style.display = "";
          if (data.anexos_boleto && data.anexos_boleto.length > 0) {
            $("r_anexos_boleto").innerHTML = data.anexos_boleto
              .map((a) => `<div>${a.nome}</div>`)
              .join("");
          } else {
            $("r_anexos_boleto").textContent = "Nenhum anexo.";
          }
        } else {
          $("r_boleto_anexos_row").style.display = "none";
        }

        // Oracle
        const oracle = data.integracao_oracle || {};
        $("o_data_gl").textContent = fmtDate(oracle.data_gl);
        $("o_data_taxa_pagto").textContent = fmtDate(oracle.data_taxa_pagto);
        $("o_data_condicoes").textContent = fmtDate(oracle.data_condicoes);
        // Os outros campos são fixos e já estão no HTML
      }

      window.addEventListener("DOMContentLoaded", () => {
        const payloadString = sessionStorage.getItem("adiantamentoPayload");
        if (!payloadString) {
          document.body.innerHTML =
            '<div class="alert alert-danger m-4">Erro: Nenhum dado de adiantamento encontrado. Por favor, preencha o formulário primeiro.</div>';
          return;
        }

        const data = JSON.parse(payloadString);

        // garantia: manter pagamento.tipo presente (se não existir)
        if (!data.pagamento) data.pagamento = {};
        data.pagamento.tipo = data.pagamento.tipo || "Pagamento Antecipado";

        // se o formulário ainda usar setor_pagamento, mantemos compatibilidade
        if (!data.solicitante && data.setor_pagamento)
          data.solicitante = data.setor_pagamento;

        populateReport(data);

        const jsonFormatted = JSON.stringify(data, null, 2);
        $("json-payload-view").textContent = jsonFormatted;

        $("btnCopyJson").addEventListener("click", () => {
          navigator.clipboard.writeText(jsonFormatted).then(() => {
            const btn = $("btnCopyJson");
            btn.textContent = "Copiado!";
            setTimeout(() => {
              btn.textContent = "Copiar JSON";
            }, 2000);
          });
        });

        $("btnDownloadJson").addEventListener("click", () => {
          const blob = new Blob([jsonFormatted], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `adiantamento-${data.fornecedor_cnpj || "payload"}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        });
      });
    </script>
  </body>
</html>
