<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Portal Financeiro - Relatório de Taxas Diversas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --brand:#72bf44; --brand-600:#5fa535; --ink:#0f172a; --muted:#64748b;
      --paper:#fff; --bg:#f3f6fb; --success:#72bf44; --danger:#e11d48;
      --border:#e5e7eb; --table-stripe:#fafbff;
    }
    body { background:var(--bg); color:var(--ink); }
    h1,h2,h3,h4,h5 { color:var(--ink); letter-spacing:.2px; }
    .topbar {
      background:linear-gradient(135deg,var(--brand) 0%,var(--brand-600) 100%);
      color:#fff; box-shadow:0 2px 8px rgba(0,0,0,.1);
    }
    .topbar .fw-bold { color:#fff; font-size:1.2rem; }
    .topbar .text-muted { color:rgba(255,255,255,.85)!important; }
    .card { border:1px solid var(--border); border-radius:12px; box-shadow:0 6px 20px rgba(2,6,23,.05); }
    .card-header {
      background:linear-gradient(180deg,#f8fdf5,#e8f5e0);
      border-bottom:1px solid var(--border);
      border-top-left-radius:12px; border-top-right-radius:12px;
    }
    .card-header h5 { color:#5fa535; font-weight:700; }
    .report-item { display:flex; justify-content:space-between; padding:.5rem 0; border-bottom:1px solid #f1f5f9; }
    .report-item:last-child { border-bottom:none; }
    .report-item span, .report-grid-item span { color:#64748b; font-size:.9rem; }
    .report-item strong, .report-grid-item strong { color:#1e293b; }
    .json-container { background:#1e293b; color:#e2e8f0; border-radius:.375rem; padding:1rem; max-height:400px; overflow-y:auto; }
    .json-container code { white-space:pre-wrap; }
    .section-title { color:#5fa535; font-weight:700; font-size:1.2rem; margin-bottom:1rem; }
    .btn-outline-secondary { border-radius:10px; font-weight:600; }
    .btn-primary { background:#72bf44; border-color:#72bf44; border-radius:10px; font-weight:600; }
    .btn-primary:hover { background:#5fa535; border-color:#5fa535; transform:translateY(-1px); box-shadow:0 4px 12px rgba(114,191,68,.3); }
  </style>
</head>
<body>
  <!-- Topbar -->
  <nav class="topbar">
    <div class="container py-2 d-flex align-items-center justify-content-between">
      <div class="fw-bold">Portal Financeiro - Relatório de Taxas Diversas</div>
      <div class="text-muted small" id="header_info"></div>
    </div>
  </nav>

  <div class="container my-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h4 class="mb-0">Relatório de Taxas Diversas</h4>
      <div>
        <button class="btn btn-outline-secondary btn-sm" onclick="window.history.back()">← Voltar</button>
        <button class="btn btn-outline-secondary btn-sm ms-2" onclick="window.print()">Imprimir</button>
      </div>
    </div>

    <div class="col-lg-11 col-xl-10 p-0">

      <!-- Resumo da Solicitação -->
      <div class="card mb-4">
        <div class="card-header"><h5 class="mb-0 section-title">Resumo da Solicitação</h5></div>
        <div class="card-body">
          <div class="report-item"><span>Empresa</span><strong id="r_empresa">—</strong></div>
          <div class="report-item"><span>Data da Solicitação</span><strong id="r_data">—</strong></div>
          <div class="report-item"><span>Setor Pagamento</span><strong id="r_setor_pagamento">—</strong></div>
          <div class="report-item"><span>Fornecedor</span><strong id="r_fornecedor_nome">—</strong></div>
          <div class="report-item"><span>Quantia da NFE</span><strong id="r_quantia_nfe">R$ 0,00</strong></div>
          <div class="report-item"><span>Descrição</span><strong id="r_descricao" class="text-end">—</strong></div>
          <div class="report-item"><span>Anexos da Solicitação</span>
            <div id="r_anexos_solicitacao" class="text-end">Nenhum anexo.</div>
          </div>
        </div>
      </div>

      <!-- Pagamento e Anexos -->
      <div class="card mb-4">
        <div class="card-header"><h5 class="mb-0 section-title">Pagamento e Anexos</h5></div>
        <div class="card-body">
          <div class="report-item"><span>Método de Pagamento</span><strong id="r_tipo_pagamento">—</strong></div>
          <div class="report-item"><span>Data do Pagamento</span><strong id="r_data_pagamento">—</strong></div>

          <div id="r_dados_bancarios" style="display:none;">
            <div class="report-item"><span>Banco</span><strong id="r_banco">—</strong></div>
            <div class="report-item"><span>Agência</span><strong id="r_agencia">—</strong></div>
            <div class="report-item"><span>Tipo de Conta</span><strong id="r_tipo_conta">—</strong></div>
            <div class="report-item"><span>Número da Conta</span><strong id="r_numero_conta">—</strong></div>
          </div>

          <div class="report-item" id="r_boleto_anexos_row" style="display:none;">
            <span>Anexos do Boleto</span>
            <div id="r_anexos_boleto" class="text-end">Nenhum anexo.</div>
          </div>
        </div>
      </div>

      <!-- Informações para o Oracle -->
      <div class="card mb-4">
        <div class="card-header"><h5 class="mb-0 section-title">Informações para o Oracle</h5></div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3 mb-3 report-grid-item"><span>Moeda</span><br><strong id="o_moeda">BRL</strong></div>
            <div class="col-md-3 mb-3 report-grid-item"><span>Data GL</span><br><strong id="o_data_gl">—</strong></div>
            <div class="col-md-3 mb-3 report-grid-item"><span>Moeda de Pagamento</span><br><strong id="o_moeda_pagamento">BRL</strong></div>
            <div class="col-md-3 mb-3 report-grid-item"><span>Data Taxa Pagto</span><br><strong id="o_data_taxa_pagto">—</strong></div>
            <div class="col-md-3 mb-3 report-grid-item"><span>Data das Condições</span><br><strong id="o_data_condicoes">—</strong></div>
            <div class="col-md-3 mb-3 report-grid-item"><span>Condições</span><br><strong id="o_condicoes">À vista</strong></div>
            <div class="col-md-3 mb-3 report-grid-item"><span>Método de Pagamento</span><br><strong id="o_metodo_pagamento">Eletrônico</strong></div>
            <div class="col-md-3 mb-3 report-grid-item"><span>Grupo de Pagamentos</span><br><strong id="o_grupo_pagamentos">Fornecedores</strong></div>
            <div class="col-md-3 mb-3 report-grid-item"><span>País para Tributação</span><br><strong id="o_pais_tributacao">Brasil</strong></div>
            <div class="col-md-3 mb-3 report-grid-item"><span>Vincular Ação</span><br><strong id="o_vincular_acao">Ordem de Compra</strong></div>
            <!-- ➤ Novo campo: Tipo de Documento -->
            <div class="col-md-3 mb-3 report-grid-item"><span>Tipo</span><br><strong id="o_tipo">Padrão/strong></div>
          </div>
        </div>
      </div>

      <!-- Payload JSON -->
      <div class="card mb-4">
        <div class="card-header"><h5 class="mb-0 section-title">Payload JSON Gerado</h5></div>
        <div class="card-body">
          <div class="d-flex justify-content-end mb-2">
            <button id="btnCopyJson" class="btn btn-sm btn-outline-secondary">Copiar JSON</button>
            <button id="btnDownloadJson" class="btn btn-sm btn-outline-secondary ms-2">Download JSON</button>
          </div>
          <div class="json-container"><code id="json-payload-view">Aguardando dados...</code></div>
        </div>
      </div>

    </div>
  </div>

  <script>
    const $ = id => document.getElementById(id);
    const fmtBRL = v => (Number(v) || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    const fmtDate = d => d ? new Date(d + 'T00:00:00').toLocaleDateString('pt-BR') : '—';
    const todayISO = () => {
      const d = new Date(), off = d.getTimezoneOffset();
      return new Date(d.getTime() - off*60000).toISOString().slice(0,10);
    };

    function populateReport(data) {
      // Header
      $('header_info').textContent = `Empresa: ${data.empresa || 'N/A'} • Usuário: agt@agt.com.br`;

      // Resumo
      $('r_empresa').textContent = data.empresa || '—';
      $('r_data').textContent = fmtDate(data.data);
      $('r_setor_pagamento').textContent = data.setor_pagamento || '—';
      $('r_fornecedor_nome').textContent = data.fornecedor_nome || '—';
      $('r_quantia_nfe').textContent = fmtBRL(data.quantia_nfe);
      $('r_descricao').textContent = data.descricao || '—';

      // Anexos da solicitação
      const anexosSolic = data.anexos_solicitacao || data.anexos || [];
      if (anexosSolic.length > 0) {
        $('r_anexos_solicitacao').innerHTML = anexosSolic.map(a => `<div>${a.nome}</div>`).join('');
      } else {
        $('r_anexos_solicitacao').textContent = 'Nenhum anexo.';
      }

      // Pagamento
      $('r_tipo_pagamento').textContent = data.pagamento?.tipo || '—';
      $('r_data_pagamento').textContent = fmtDate(data.pagamento?.data_pagamento);

      if (data.pagamento?.tipo === 'Eletronico' && data.pagamento.bancarios) {
        $('r_dados_bancarios').style.display = 'block';
        $('r_banco').textContent = data.pagamento.bancarios.banco || '—';
        $('r_agencia').textContent = data.pagamento.bancarios.agencia || '—';
        $('r_tipo_conta').textContent = data.pagamento.bancarios.tipo_conta || '—';
        $('r_numero_conta').textContent = data.pagamento.bancarios.numero_conta || '—';
      } else {
        $('r_dados_bancarios').style.display = 'none';
      }

      // Anexos do boleto
      const anexosBoleto = data.anexos_boleto || data.pagamento?.anexos_boleto || [];
      if (data.pagamento?.tipo === 'boleto') {
        $('r_boleto_anexos_row').style.display = '';
        if (anexosBoleto.length > 0) {
          $('r_anexos_boleto').innerHTML = anexosBoleto.map(a => `<div>${a.nome}</div>`).join('');
        } else {
          $('r_anexos_boleto').textContent = 'Nenhum anexo.';
        }
      } else {
        $('r_boleto_anexos_row').style.display = 'none';
      }

      // Oracle
      const refDate = data.data || todayISO();
      const oracle = data.integracao_oracle || {
        moeda: 'BRL',
        data_gl: refDate,
        moeda_pagamento: 'BRL',
        data_taxa_pagto: refDate,
        data_condicoes: refDate,
        condicoes: 'À vista',
        metodo_pagamento: 'Eletrônico',
        grupo_pagamentos: 'Fornecedores',
        pais_tributacao: 'Brasil',
        vincular_acao: 'Ordem de Compra'
      };

      $('o_moeda').textContent = oracle.moeda || 'BRL';
      $('o_data_gl').textContent = fmtDate(oracle.data_gl);
      $('o_moeda_pagamento').textContent = oracle.moeda_pagamento || 'BRL';
      $('o_data_taxa_pagto').textContent = fmtDate(oracle.data_taxa_pagto);
      $('o_data_condicoes').textContent = fmtDate(oracle.data_condicoes);
      $('o_condicoes').textContent = oracle.condicoes || 'À vista';
      $('o_metodo_pagamento').textContent = oracle.metodo_pagamento || 'Eletrônico';
      $('o_grupo_pagamentos').textContent = oracle.grupo_pagamentos || 'Fornecedores';
      $('o_pais_tributacao').textContent = oracle.pais_tributacao || 'Brasil';
      $('o_vincular_acao').textContent = oracle.vincular_acao || 'Ordem de Compra';

      // ➤ Novo: Tipo de Documento (vem do payload root)
      $('o_tipo').textContent = 'Padrão';

      // JSON exibido
      if (!data.integracao_oracle) data.integracao_oracle = oracle;
      const jsonFormatted = JSON.stringify(data, null, 2);
      $('json-payload-view').textContent = jsonFormatted;

      // Botões JSON
      $('btnCopyJson').addEventListener('click', () => {
        navigator.clipboard.writeText(jsonFormatted).then(() => {
          const btn = $('btnCopyJson'); 
          btn.textContent = 'Copiado!'; 
          setTimeout(() => btn.textContent = 'Copiar JSON', 2000);
        });
      });
      $('btnDownloadJson').addEventListener('click', () => {
        const blob = new Blob([jsonFormatted], { type:'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const safeName = (data.fornecedor_nome || 'payload').replace(/[^\p{L}\p{N}_-]+/gu,'_');
        a.href = url; 
        a.download = `taxas-diversas-${safeName}.json`;
        document.body.appendChild(a); 
        a.click(); 
        document.body.removeChild(a); 
        URL.revokeObjectURL(url);
      });
    }

    window.addEventListener('DOMContentLoaded', () => {
      const payloadString = sessionStorage.getItem('taxasDiversasPayload');
      if (!payloadString) {
        document.body.innerHTML = '<div class="alert alert-danger m-4">Erro: Nenhum dado de Taxas Diversas encontrado. Por favor, preencha o formulário primeiro.</div>';
        return;
      }
      populateReport(JSON.parse(payloadString));
    });
  </script>
</body>
</html>