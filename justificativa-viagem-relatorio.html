<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Relatório de Acerto de Contas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root {
      --brand: #72bf44;
      --brand-600: #5fa535;
      --ink: #0f172a;
      --muted: #64748b;
      --paper: #ffff;
      --bg: #f3f6fb;
      --success: #16a34a;
      --danger: #e11d48;
      --warning: #f59e0b;
      --border: #e5e7eb;
      --table-stripe: #fafbff;
    }

    body {
      background: var(--bg);
      color: var(--ink);
    }

    h1,
    h2,
    h3,
    h4,
    h5 {
      color: var(--ink);
      letter-spacing: .2px;
    }

    .topbar {
      background: linear-gradient(135deg, var(--brand) 0%, var(--brand-600) 100%);
      color: #fff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .topbar .fw-bold {
      color: #fff;
      font-size: 1.2rem;
    }

    .topbar .text-muted {
      color: rgba(255, 255, 255, 0.85) !important;
    }

    .card {
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(2, 6, 23, .05);
      background: var(--paper);
    }

    .card-header {
      background: linear-gradient(180deg, #f8fdf5, #e8f5e0);
      border-bottom: 1px solid var(--border);
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
    }

    .card-header h5 {
      color: var(--brand-600);
      font-weight: 700;
    }

    .table {
      --bs-table-striped-bg: var(--table-stripe);
      border-color: var(--border);
    }

    .table thead th {
      background: #e8f5e0;
      color: var(--brand-600);
      font-weight: 700;
      font-size: 0.85rem;
    }

    .table>tbody>tr>td {
      vertical-align: middle;
      font-size: 0.9rem;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      font-weight: 600;
      color: var(--muted);
    }

    .info-value {
      font-weight: 700;
      color: var(--ink);
    }

    .resultado-final {
      background: linear-gradient(135deg, #f8fdf5 0%, #e8f5e0 100%);
      border: 2px solid var(--brand);
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      margin: 24px 0;
    }

    .resultado-final h3 {
      color: var(--brand-600);
      font-weight: 700;
      margin-bottom: 16px;
    }

    .resultado-valor {
      font-size: 2.5rem;
      font-weight: 800;
      margin: 16px 0;
    }

    .resultado-valor.devolver {
      color: var(--danger);
    }

    .resultado-valor.receber {
      color: var(--success);
    }

    .resultado-valor.quitado {
      color: var(--brand-600);
    }

    .status-badge {
      display: inline-block;
      padding: 8px 20px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 0.9rem;
      margin-top: 12px;
    }

    .status-badge.devolver {
      background: #fee2e2;
      color: var(--danger);
    }

    .status-badge.receber {
      background: #dcfce7;
      color: var(--success);
    }

    .status-badge.quitado {
      background: #e8f5e0;
      color: var(--brand-600);
    }

    .btn-primary {
      background: var(--brand);
      border-color: var(--brand);
      border-radius: 10px;
      font-weight: 600;
    }

    .btn-primary:hover {
      background: var(--brand-600);
      border-color: var(--brand-600);
    }

    .btn-outline-secondary {
      border-radius: 10px;
      font-weight: 600;
    }

    .timeline {
      position: relative;
      padding-left: 30px;
    }

    .timeline::before {
      content: '';
      position: absolute;
      left: 8px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--border);
    }

    .timeline-item {
      position: relative;
      padding-bottom: 20px;
    }

    .timeline-item::before {
      content: '';
      position: absolute;
      left: -26px;
      top: 5px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--brand);
      border: 2px solid var(--paper);
      box-shadow: 0 0 0 2px var(--brand);
    }

    .timeline-item h6 {
      font-weight: 700;
      color: var(--brand-600);
      margin-bottom: 4px;
    }

    .timeline-item p {
      margin: 0;
      color: var(--muted);
      font-size: 0.9rem;
    }

    @media print {
      .no-print {
        display: none !important;
      }

      body {
        background: white;
      }

      .card {
        box-shadow: none;
        page-break-inside: avoid;
      }
    }
  </style>
</head>

<body>
  <nav class="topbar no-print">
    <div class="container py-2 d-flex align-items-center justify-content-between">
      <div class="fw-bold">Relatório de Acerto de Contas</div>
      <div class="text-muted small">
        Empresa: <span id="empresaSpan">EMPRESA_A</span> • Usuário: <span id="usuarioSpan">agt@agt.com.br</span>
      </div>
    </div>
  </nav>

  <div class="container my-4">
    <!-- Card: Identificação -->
    <div class="card mb-4">
      <div class="card-header">
        <h5><i class="fas fa-file-invoice-dollar me-2"></i>Relatório de Acerto de Contas - Viagem</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <div class="info-row">
              <span class="info-label">Empresa:</span>
              <span class="info-value" id="rel_empresa">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Colaborador:</span>
              <span class="info-value" id="rel_colaborador">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Matrícula:</span>
              <span class="info-value" id="rel_matricula">-</span>
            </div>
          </div>
          <div class="col-md-6">
            <div class="info-row">
              <span class="info-label">Setor:</span>
              <span class="info-value" id="rel_setor">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Data da Viagem:</span>
              <span class="info-value" id="rel_dataViagem">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Local/Finalidade:</span>
              <span class="info-value" id="rel_localFinalidade">-</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Card: Histórico do Processo -->
    <div class="card mb-4">
      <div class="card-header">
        <h5><i class="fas fa-history me-2"></i>Histórico do Processo</h5>
      </div>
      <div class="card-body">
        <div class="timeline">
          <div class="timeline-item">
            <h6>1. Adiantamento Solicitado</h6>
            <p>Valor: <strong id="hist_valorAdiantamento">R$ 0,00</strong></p>
            <p>Data: <strong id="hist_dataAdiantamento">-</strong></p>
            <p>Motivo: <strong id="hist_motivo">-</strong></p>
          </div>
          <div class="timeline-item">
            <h6>2. Despesas Realizadas</h6>
            <p>Total de despesas lançadas: <strong id="hist_totalDespesas">R$ 0,00</strong></p>
            <p>Quantidade de itens: <strong id="hist_qtdDespesas">0</strong></p>
          </div>
          <div class="timeline-item">
            <h6>3. Acerto Calculado</h6>
            <p>Data do acerto: <strong id="hist_dataAcerto">-</strong></p>
            <p>Status: <strong id="hist_status">-</strong></p>
          </div>
        </div>
      </div>
    </div>

    <!-- Card: Despesas Detalhadas -->
    <div class="card mb-4">
      <div class="card-header">
        <h5><i class="fas fa-list-ul me-2"></i>Despesas Realizadas</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>#</th>
                <th>Descrição</th>
                <th>Chave</th>
                <th>Data</th>
                <th>Qtd</th>
                <th>Valor Unit.</th>
                <th>Subtotal</th>
                <th>Comprovante</th>
              </tr>
            </thead>
            <tbody id="tabelaDespesasRelatorio"></tbody>
            <tfoot>
              <tr>
                <th colspan="6" class="text-end">Total de Despesas:</th>
                <th id="totalDespesasRelatorio">R$ 0,00</th>
                <th></th>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>

    <!-- Card: Resultado Final -->
    <div class="card mb-4">
      <div class="card-header">
        <h5><i class="fas fa-calculator me-2"></i>Cálculo do Acerto</h5>
      </div>
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <div class="info-row">
              <span class="info-label">Valor do Adiantamento:</span>
              <span class="info-value" id="calc_adiantamento">R$ 0,00</span>
            </div>
          </div>
          <div class="col-md-6">
            <div class="info-row">
              <span class="info-label">Total de Despesas:</span>
              <span class="info-value" id="calc_despesas">R$ 0,00</span>
            </div>
          </div>
        </div>

        <div class="resultado-final">
          <h3><i class="fas fa-balance-scale me-2"></i>Resultado do Acerto</h3>
          <div id="resultadoTexto" class="mb-2">-</div>
          <div id="resultadoValor" class="resultado-valor">R$ 0,00</div>
          <div id="resultadoBadge" class="status-badge">-</div>
        </div>

        <div id="observacoesContainer" style="display: none;">
          <hr>
          <h6 class="mb-2"><i class="fas fa-comment-dots me-2"></i>Observações</h6>
          <p id="rel_observacoes" class="text-muted mb-0">-</p>
        </div>
      </div>
    </div>

    <!-- Card: Dados para Oracle (Mockup) -->
    <div class="card mb-4">
      <div class="card-header">
        <h5><i class="fas fa-database me-2"></i>Dados para Integração Oracle (Mockup/Simulador)</h5>
      </div>
      <div class="card-body">
        <div class="alert alert-info mb-3">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Simulação:</strong> Estes dados seriam enviados para o sistema Oracle após aprovação.
        </div>
        <div class="row g-3">
          <div class="col-md-6">
            <div class="info-row">
              <span class="info-label">Tipo:</span>
              <span class="info-value" id="oracle_tipo">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Parceiro Comercial:</span>
              <span class="info-value" id="oracle_parceiro">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">NR Fornecedor:</span>
              <span class="info-value" id="oracle_fornecedor">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Empresa:</span>
              <span class="info-value" id="oracle_empresa">-</span>
            </div>
          </div>
          <div class="col-md-6">
            <div class="info-row">
              <span class="info-label">Filial:</span>
              <span class="info-value" id="oracle_filial">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Valor Total:</span>
              <span class="info-value" id="oracle_valor">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Tipo de Pagamento:</span>
              <span class="info-value" id="oracle_tipoPagamento">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Status:</span>
              <span class="info-value" id="oracle_status">Pendente de Aprovação</span>
            </div>
          </div>
        </div>

        <div class="mt-3">
          <h6 class="mb-2">Itens de Despesa (Oracle):</h6>
          <div class="table-responsive">
            <table class="table table-sm table-bordered">
              <thead>
                <tr>
                  <th>Chave Contábil</th>
                  <th>Descrição</th>
                  <th>Quantidade</th>
                  <th>Valor</th>
                </tr>
              </thead>
              <tbody id="oracleItensTabela"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Botões de Ação -->
    <div class="d-flex gap-2 mb-4 no-print">
      <button class="btn btn-primary flex-fill" onclick="window.print()">
        <i class="fas fa-print me-2"></i>Imprimir / Salvar PDF
      </button>
      <button class="btn btn-outline-secondary flex-fill" onclick="novaJustificativa()">
        <i class="fas fa-plus me-2"></i>Nova Justificativa
      </button>
      <button class="btn btn-outline-secondary flex-fill" onclick="voltarInicio()">
        <i class="fas fa-home me-2"></i>Voltar ao Início
      </button>
    </div>
  </div>

  <script>
    function formatCurrency(value) {
      return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function formatDate(dateString) {
      if (!dateString) return '__/__/____';
      return new Date(dateString + 'T00:00:00').toLocaleDateString('pt-BR');
    }

    function carregarRelatorio() {
      const dadosStr = sessionStorage.getItem('dadosJustificativaViagem');

      if (!dadosStr) {
        alert('Nenhum dado de justificativa encontrado.');
        window.location.href = 'justificativa-viagem.html';
        return;
      }

      const dados = JSON.parse(dadosStr);
      console.log('Dados carregados:', dados);

      // Identificação
      document.getElementById('rel_empresa').textContent = dados.empresa || '-';
      document.getElementById('rel_colaborador').textContent = dados.colaborador || '-';
      document.getElementById('rel_matricula').textContent = dados.matricula || '-';
      document.getElementById('rel_setor').textContent = dados.setor || '-';
      document.getElementById('rel_dataViagem').textContent = formatDate(dados.dataViagem);
      document.getElementById('rel_localFinalidade').textContent = dados.localFinalidade || '-';

      // Histórico
      const dadosAdiantamento = dados.dadosAdiantamento;
      if (dadosAdiantamento) {
        document.getElementById('hist_valorAdiantamento').textContent = formatCurrency(dadosAdiantamento.valorAdiantamento);
        document.getElementById('hist_dataAdiantamento').textContent = formatDate(dadosAdiantamento.dataAdiantamento);
        document.getElementById('hist_motivo').textContent = dadosAdiantamento.motivo;
      } else {
        document.getElementById('hist_valorAdiantamento').textContent = formatCurrency(dados.valorAdiantamento);
        document.getElementById('hist_dataAdiantamento').textContent = '-';
        document.getElementById('hist_motivo').textContent = dados.localFinalidade || '-';
      }

      document.getElementById('hist_totalDespesas').textContent = formatCurrency(dados.totalGastos);
      document.getElementById('hist_qtdDespesas').textContent = dados.despesas.length;
      document.getElementById('hist_dataAcerto').textContent = new Date().toLocaleDateString('pt-BR');

      // Tabela de despesas
      const tbody = document.getElementById('tabelaDespesasRelatorio');
      tbody.innerHTML = '';
      dados.despesas.forEach((d, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${d.descricao}</td>
          <td><code>${d.chave}</code></td>
          <td>${formatDate(d.data)}</td>
          <td>${d.quantidade}</td>
          <td>${formatCurrency(d.valorUnitario)}</td>
          <td>${formatCurrency(d.subtotal)}</td>
          <td><small class="text-muted">${d.comprovante || '-'}</small></td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById('totalDespesasRelatorio').textContent = formatCurrency(dados.totalGastos);

      // Cálculo
      const adiantamento = dados.valorAdiantamento;
      const totalGastos = dados.totalGastos;
      const diferenca = totalGastos - adiantamento;

      document.getElementById('calc_adiantamento').textContent = formatCurrency(adiantamento);
      document.getElementById('calc_despesas').textContent = formatCurrency(totalGastos);

      const resultadoTexto = document.getElementById('resultadoTexto');
      const resultadoValor = document.getElementById('resultadoValor');
      const resultadoBadge = document.getElementById('resultadoBadge');

      if (diferenca > 0) {
        // Empresa deve pagar
        resultadoTexto.textContent = 'Empresa deve reembolsar ao colaborador:';
        resultadoValor.textContent = formatCurrency(diferenca);
        resultadoValor.className = 'resultado-valor receber';
        resultadoBadge.textContent = 'A RECEBER';
        resultadoBadge.className = 'status-badge receber';
        document.getElementById('hist_status').textContent = 'A Receber';
        document.getElementById('hist_status').style.color = 'var(--success)';
      } else if (diferenca < 0) {
        // Colaborador deve devolver
        resultadoTexto.textContent = 'Colaborador deve devolver à empresa:';
        resultadoValor.textContent = formatCurrency(Math.abs(diferenca));
        resultadoValor.className = 'resultado-valor devolver';
        resultadoBadge.textContent = 'A DEVOLVER';
        resultadoBadge.className = 'status-badge devolver';
        document.getElementById('hist_status').textContent = 'A Devolver';
        document.getElementById('hist_status').style.color = 'var(--danger)';
      } else {
        // Quitado
        resultadoTexto.textContent = 'Contas acertadas:';
        resultadoValor.textContent = 'QUITADO';
        resultadoValor.className = 'resultado-valor quitado';
        resultadoBadge.textContent = 'QUITADO';
        resultadoBadge.className = 'status-badge quitado';
        document.getElementById('hist_status').textContent = 'Quitado';
        document.getElementById('hist_status').style.color = 'var(--brand-600)';
      }

      // Observações
      if (dados.observacoes) {
        document.getElementById('observacoesContainer').style.display = 'block';
        document.getElementById('rel_observacoes').textContent = dados.observacoes;
      }

      // Dados Oracle
      document.getElementById('oracle_tipo').textContent = diferenca > 0 ? 'Reembolso' : diferenca < 0 ? 'Devolução' : 'Quitação';
      document.getElementById('oracle_parceiro').textContent = dados.colaborador;
      document.getElementById('oracle_fornecedor').textContent = dados.matricula || 'N/A';
      document.getElementById('oracle_empresa').textContent = dados.empresa;
      document.getElementById('oracle_filial').textContent = 'Filial 001';
      document.getElementById('oracle_valor').textContent = formatCurrency(Math.abs(diferenca));
      document.getElementById('oracle_tipoPagamento').textContent = diferenca !== 0 ? 'Depósito Bancário' : 'N/A';

      // Itens Oracle
      const oracleItens = document.getElementById('oracleItensTabela');
      oracleItens.innerHTML = '';
      dados.despesas.forEach(d => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><code>${d.chave}</code></td>
          <td>${d.descricao}</td>
          <td>${d.quantidade}</td>
          <td>${formatCurrency(d.subtotal)}</td>
        `;
        oracleItens.appendChild(tr);
      });
    }

    function novaJustificativa() {
      sessionStorage.removeItem('dadosJustificativaViagem');
      sessionStorage.removeItem('dadosAcertoViagem');
      window.location.href = 'justificativa-viagem.html';
    }

    function voltarInicio() {
      window.location.href = 'adiantamento-viagem.html';
    }

    document.addEventListener('DOMContentLoaded', carregarRelatorio);
  </script>
</body>

</html>