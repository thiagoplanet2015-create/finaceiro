<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Portal Financeiro - Taxas Diversas</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --brand: #72bf44;
        --brand-600: #5fa535;
        --ink: #0f172a;
        --muted: #64748b;
        --paper: #fff;
        --bg: #f3f6fb;
        --border: #e5e7eb;
      }
      body {
        background: var(--bg);
        color: var(--ink);
      }
      .topbar {
        background: linear-gradient(
          135deg,
          var(--brand) 0%,
          var(--brand-600) 100%
        );
        color: #fff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .topbar .fw-bold {
        color: #fff;
        font-size: 1.2rem;
      }
      .topbar .text-muted {
        color: rgba(255, 255, 255, 0.85) !important;
      }
      .card {
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(2, 6, 23, 0.05);
      }
      .card-header {
        background: linear-gradient(180deg, #f8fdf5, #e8f5e0);
        border-bottom: 1px solid var(--border);
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
      }
      .card-header h5 {
        color: #5fa535;
        font-weight: 700;
      }
      .form-label {
        font-weight: 600;
        color: #334155;
      }
      .form-control,
      .form-select {
        border-radius: 10px;
        border: 1px solid var(--border);
        transition: border-color 0.2s, box-shadow 0.2s;
      }
      .form-control:focus,
      .form-select:focus {
        border-color: var(--brand);
        box-shadow: 0 0 0 0.2rem rgba(114, 191, 68, 0.25);
      }
      .btn-primary {
        background: var(--brand);
        border-color: var(--brand);
        border-radius: 10px;
        font-weight: 600;
      }
      .btn-primary:hover {
        background: #5fa535;
        border-color: #5fa535;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(114, 191, 68, 0.3);
      }
      .btn-outline-primary {
        border-radius: 10px;
        font-weight: 600;
        color: var(--brand);
        border-color: var(--brand);
      }
      .btn-outline-primary:hover {
        background: var(--brand);
        color: #fff;
      }
      .btn-outline-secondary {
        border-radius: 10px;
        font-weight: 600;
      }
      .btn-outline-danger {
        border-radius: 8px;
        font-weight: 600;
      }
      .file-list li {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem;
        border-bottom: 1px solid var(--border);
      }
      .file-list li:last-child {
        border-bottom: none;
      }
      .required::after {
        content: " *";
        color: #e11d48;
      }
      /* preview styling (discreet) */
      #descricao_preview {
        color: var(--muted);
        font-size: 0.95rem;
        padding-left: 6px;
        min-height: 20px;
        display: none;
      }
    </style>
  </head>
  <body>
    <!-- Topbar -->
    <nav class="topbar">
      <div
        class="container py-2 d-flex align-items-center justify-content-between"
      >
        <div class="fw-bold">Portal Financeiro - Taxas Diversas</div>
        <div class="text-muted small">
          Empresa: <span id="empresaSpan">16</span> • Usuário:
          <span id="usuarioSpan">agt@agt.com.br</span>
        </div>
      </div>
    </nav>

    <div class="container my-4">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <h4 class="mb-0">Nova Taxa Diversa</h4>
        <a href="#" class="btn btn-outline-secondary btn-sm">← Voltar</a>
      </div>

      <div class="col-lg-11 col-xl-10 p-0">
        <!-- Dados da Solicitação -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Dados da Solicitação</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label required">Empresa</label>
                <select id="empresa" class="form-select" required>
                  <option value="">Selecione a empresa</option>
                  <option value="05">05 - Agroterenas Citrus Ltda.</option>
                  <option value="11">
                    11 - Agroterenas Industrial Citrus Ltda.
                  </option>
                  <option value="16">16 - Agroterenas S/A - Cana</option>
                  <option value="20">20 - Agt Estrela do Oeste</option>
                  <option value="21">
                    21 - Agroterenas International E.C.
                  </option>
                  <option value="24">24 - Agroterenas International LLC</option>
                  <option value="30">
                    30 - Agroterenas S/A - Administração e Participações
                  </option>
                  <option value="40">40 - Agroventura</option>
                  <option value="41">41 - Agroterenas Terras Ltda.</option>
                  <option value="42">42 - Associação Semear</option>
                  <option value="43">43 - AGT Adubos e Fertilizantes</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label required">Data</label>
                <input id="data" type="date" class="form-control" required />
              </div>
              <div class="col-md-4">
                <label class="form-label required">Solicitante</label>
                <input
                  id="setor_pagamento"
                  class="form-control"
                  placeholder="Ex.: João Silva"
                  required
                />
              </div>
              <div class="col-md-6">
                <label class="form-label required"
                  >Nome do Fornecedor (Parceiro Comercial)</label
                >
                <input id="fornecedor_nome" class="form-control" required />
              </div>
              <div class="col-md-6">
                <label class="form-label required">Quantia da NFE</label>
                <input
                  id="quantia_nfe"
                  type="number"
                  step="0.01"
                  min="0"
                  class="form-control"
                  required
                />
              </div>
              <div class="col-12">
                <label class="form-label required">Descrição</label>

                <!-- preview (read-only) mostrado acima do textarea -->
                <div id="descricao_preview" class="small text-muted mb-2">
                  &nbsp;
                </div>

                <textarea
                  id="descricao"
                  class="form-control"
                  rows="3"
                  required
                ></textarea>
              </div>
            </div>

            <hr class="my-4" />
            <label class="form-label">Anexos da Solicitação</label>
            <div class="row g-2 align-items-center">
              <div class="col-lg-6">
                <input
                  id="inputFileSolicitacao"
                  type="file"
                  class="form-control"
                  multiple
                />
              </div>
              <div class="col-auto">
                <button
                  class="btn btn-outline-primary"
                  id="btnUploadSolicitacao"
                >
                  + Adicionar anexo
                </button>
              </div>
            </div>
            <ul
              id="listaArquivosSolicitacao"
              class="mt-3 list-unstyled file-list border rounded"
              style="display: none"
            ></ul>
          </div>
        </div>

        <!-- Pagamento e Anexos -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Pagamento e Anexos</h5>
          </div>
          <div class="card-body">
            <div class="row g-3 mb-3">
              <div class="col-md-4">
                <label class="form-label required">Metodo de pagamento</label>
                <select id="metodo_pagamento" class="form-select" required>
                  <option value="">Selecione</option>
                  <option value="boleto">Boleto</option>
                  <option value="Eletronico">Eletronico</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label required">Data do pagamento</label>
                <input
                  id="data_pagamento"
                  type="date"
                  class="form-control"
                  required
                />
              </div>
            </div>

            <div class="row g-3">
              <!-- BLOCO BOLETO -->
              <div class="col-12" id="grupoBoleto" style="display: none">
                <div class="alert alert-info py-2 mb-0">
                  Para pagamento via boleto, anexe o PDF/XML abaixo.
                </div>
                <div class="row g-2 align-items-center mt-2">
                  <div class="col-lg-6">
                    <input
                      id="inputFileBoleto"
                      type="file"
                      class="form-control"
                      multiple
                    />
                  </div>
                  <div class="col-auto">
                    <button
                      class="btn btn-outline-primary"
                      id="btnUploadBoleto"
                    >
                      + Adicionar anexo
                    </button>
                  </div>
                </div>
                <ul
                  id="listaArquivosBoleto"
                  class="mt-3 list-unstyled file-list border rounded"
                  style="display: none"
                ></ul>
              </div>

              <!-- BLOCO DEPÓSITO -->
              <div id="grupoDeposito" class="row g-3 d-none">
                <div class="col-md-3">
                  <label class="form-label required">Banco</label>
                  <input id="banco" class="form-control" />
                </div>
                <div class="col-md-3">
                  <label class="form-label required">Agência</label>
                  <input id="agencia" class="form-control" />
                </div>
                <div class="col-md-3">
                  <label class="form-label required">Tipo de conta</label>
                  <select id="tipo_conta" class="form-select">
                    <option value="">Selecione</option>
                    <option value="corrente">Corrente</option>
                    <option value="poupanca">Poupança</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label required">Número da conta</label>
                  <input id="numero_conta" class="form-control" />
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Ações -->
        <div class="d-flex justify-content-center gap-3 mb-4">
          <button
            id="btnRascunho"
            type="button"
            class="btn btn-outline-secondary"
          >
            Salvar como rascunho
          </button>
          <button id="btnEnviar" type="button" class="btn btn-primary">
            Enviar para Análise »
          </button>
        </div>
      </div>
    </div>

    <script>
      const hojeISO = () => {
        const d = new Date(),
          off = d.getTimezoneOffset();
        return new Date(d.getTime() - off * 60000).toISOString().slice(0, 10);
      };
      const $ = (id) => document.getElementById(id);

      // Anexos (Solicitação e Boleto)
      const anexosSolicitacao = [];
      const anexosBoleto = [];

      function renderAnexos(list, ulId) {
        const ul = $(ulId);
        ul.innerHTML = "";
        if (list.length === 0) {
          ul.style.display = "none";
          return;
        }
        ul.style.display = "block";
        list.forEach((a, i) => {
          const li = document.createElement("li");
          li.innerHTML = `<span>${a.name} (${(a.size / 1024).toFixed(
            1
          )} KB)</span>
            <button class="btn btn-sm btn-outline-danger" data-index="${i}">Remover</button>`;
          ul.appendChild(li);
        });
      }
      function addFiles(e, inputId, list, ulId) {
        e.preventDefault();
        const files = Array.from($(inputId).files || []);
        files.forEach((f) => list.push({ name: f.name, size: f.size }));
        $(inputId).value = "";
        renderAnexos(list, ulId);
      }
      function removeFile(e, list, ulId) {
        if (e.target.tagName === "BUTTON") {
          list.splice(e.target.dataset.index, 1);
          renderAnexos(list, ulId);
        }
      }

      function togglePagamento() {
        // "Eletronico" => mostra dados bancários; "boleto" mostra anexo de boleto
        const tipo = $("metodo_pagamento").value;
        $("grupoDeposito").classList.toggle("d-none", tipo !== "Eletronico");
        $("grupoBoleto").style.display = tipo === "boleto" ? "" : "none";
      }

      function validarObrigatorios() {
        const obrig = [
          "empresa",
          "data",
          "setor_pagamento",
          "fornecedor_nome",
          "quantia_nfe",
          "descricao",
          "metodo_pagamento",
          "data_pagamento",
        ];
        if ($("metodo_pagamento").value === "Eletronico") {
          obrig.push("banco", "agencia", "tipo_conta", "numero_conta");
        }
        let ok = true;
        obrig.forEach((id) => {
          const el = $(id);
          if (!el || !el.value) {
            el?.classList.add("is-invalid");
            ok = false;
          } else el.classList.remove("is-invalid");
        });
        return ok;
      }

      // --- SINCRONIZAÇÃO: preview somente (NÃO altera textarea) ---
      function updateDescricaoPreview() {
        const solicitante = ($("setor_pagamento")?.value || "").trim();
        const motivo = ($("descricao")?.value || "").trim();
        const preview = `Solicitante: ${solicitante} - Motivo: ${motivo}`;
        $("descricao_preview").textContent = preview;
      }

      const solicitanteInput = document.getElementById("setor_pagamento");
      const saidaTextarea = document.getElementById("descricao");

      function atualizarSaida() {
        const solicitante = solicitanteInput.value.trim();
        saidaTextarea.value = `Solicitante: ${solicitante} - Motivo: `;
      }
      solicitanteInput.addEventListener('input', atualizarSaida);

      // --- fim sincronização ---

      function payload() {
        const solicitante = ($("setor_pagamento")?.value || "").trim();
        const motivo = ($("descricao")?.value || "").trim();

        return {
          tipo: "Padrão", // ⭐️ CAMPO FIXO NO JSON, NÃO EXIBIDO NA INTERFACE
          empresa: $("empresa")?.value,
          data: $("data")?.value,
          setor_pagamento: solicitante,
          fornecedor_nome: $("fornecedor_nome")?.value,
          quantia_nfe: Number($("quantia_nfe")?.value || 0),
          descricao: motivo, // mantemos somente o motivo no campo descricao
          descricao_completa: `Solicitante: ${solicitante} - Motivo: ${motivo}`,
          anexos_solicitacao: anexosSolicitacao.map((a) => ({
            nome: a.name,
            tamanho: a.size,
          })),
          pagamento: {
            tipo: $("metodo_pagamento")?.value,
            data_pagamento: $("data_pagamento")?.value,
            bancarios:
              $("metodo_pagamento")?.value === "Eletronico"
                ? {
                    banco: $("banco")?.value,
                    agencia: $("agencia")?.value,
                    tipo_conta: $("tipo_conta")?.value,
                    numero_conta: $("numero_conta")?.value,
                  }
                : null,
          },
          anexos_boleto:
            $("metodo_pagamento")?.value === "boleto"
              ? anexosBoleto.map((a) => ({ nome: a.name, tamanho: a.size }))
              : [],
        };
      }

      window.addEventListener("DOMContentLoaded", () => {
        $("data").value = hojeISO();
        $("data_pagamento").value = hojeISO();

        $("btnUploadSolicitacao").addEventListener("click", (e) =>
          addFiles(
            e,
            "inputFileSolicitacao",
            anexosSolicitacao,
            "listaArquivosSolicitacao"
          )
        );
        $("listaArquivosSolicitacao").addEventListener("click", (e) =>
          removeFile(e, anexosSolicitacao, "listaArquivosSolicitacao")
        );

        $("btnUploadBoleto").addEventListener("click", (e) =>
          addFiles(e, "inputFileBoleto", anexosBoleto, "listaArquivosBoleto")
        );
        $("listaArquivosBoleto").addEventListener("click", (e) =>
          removeFile(e, anexosBoleto, "listaArquivosBoleto")
        );

        $("metodo_pagamento").addEventListener("change", () => {
          togglePagamento();
          // limpa anexos de boleto caso mude para não-boleto
          if ($("metodo_pagamento").value !== "boleto") {
            anexosBoleto.length = 0;
            renderAnexos(anexosBoleto, "listaArquivosBoleto");
          }
        });

        // listeners para atualizar apenas o preview em tempo real
        $("setor_pagamento").addEventListener("input", updateDescricaoPreview);
        $("descricao").addEventListener("input", updateDescricaoPreview);

        // inicializa preview (mantendo conteúdo atual do textarea)
        updateDescricaoPreview();

        $("btnRascunho").addEventListener("click", () => {
          if (!validarObrigatorios())
            return alert("Preencha os campos obrigatórios.");
          console.log("Salvar rascunho:", payload());
          alert("Rascunho preparado (veja o console).");
        });

        $("btnEnviar").addEventListener("click", () => {
          if (!validarObrigatorios()) {
            alert("Preencha todos os campos obrigatórios antes de continuar.");
            return;
          }
          const data = payload();

          // Gera “Dados Oracle” conforme solicitado
          const hoje =
            document.getElementById("data")?.value ||
            (() => {
              const d = new Date(),
                off = d.getTimezoneOffset();
              return new Date(d.getTime() - off * 60000)
                .toISOString()
                .slice(0, 10);
            })();

          data.integracao_oracle = {
            moeda: "BRL",
            data_gl: hoje,
            moeda_pagamento: "BRL",
            data_taxa_pagto: hoje,
            data_condicoes: hoje,
            condicoes: "À vista",
            metodo_pagamento:
              $("metodo_pagamento")?.value === "Eletronico"
                ? "Eletrônico"
                : "Boleto",
            grupo_pagamentos: "Fornecedores",
            pais_tributacao: "Brasil",
            vincular_acao: "Ordem de Compra",
          };

          sessionStorage.setItem("taxasDiversasPayload", JSON.stringify(data));
          window.location.href = "taxas-diversas-relatorio.html";
        });

        togglePagamento();
      });
    </script>
  </body>
</html>